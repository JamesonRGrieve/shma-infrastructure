---
- name: Build ingress model for sample service
  hosts: localhost
  gather_facts: false
  connection: local
  vars:
    ingress_service_definition_file: "{{ service_definition_file | default(playbook_dir ~ '/sample_service_ingress.yml') }}"
  tasks:
    - name: Load service definition with ingress intent
      ansible.builtin.include_vars:
        file: "{{ ingress_service_definition_file }}"
        name: service_spec

    - name: Verify jsonschema availability
      ansible.builtin.command: "{{ ansible_playbook_python }} -c 'import jsonschema'"
      register: jsonschema_check
      changed_when: false
      failed_when: false

    - name: Skip ingress modeling when jsonschema missing
      ansible.builtin.debug:
        msg: "jsonschema not available; skipping ingress_model role"
      when: jsonschema_check.rc != 0

    - name: Abort play when jsonschema missing
      ansible.builtin.meta: end_play
      when: jsonschema_check.rc != 0

    - name: Generate ingress model
      ansible.builtin.include_role:
        name: roles/ingress_model

    - name: Assert ingress model built
      ansible.builtin.assert:
        that:
          - ingress_enabled | bool
          - ingress_edge_config | length == 1
          - ingress_edge_config[0].hostname == 'sample.example.test'
          - ingress_edge_config[0].upstreams[0].host == service_spec.service_ip
          - ingress_metadata.spec_hash is defined
        fail_msg: "Ingress model generation failed"

    - name: Display ingress edge configuration
      ansible.builtin.debug:
        var: ingress_edge_config
