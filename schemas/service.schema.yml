---
type: object
required:
  - service_id
  - service_name
  - service_image
  - exports
  - mounts
  - health
  - runtime_templates
properties:
  service_id:
    type: string
  service_name:
    type: string
  service_unit_name:
    type: string
  service_image:
    type: string
    pattern: "^.+@sha256:[0-9a-f]{64}$"
  service_ip:
    type: string
  service_port:
    type: object
    deprecated: true
    properties:
      target:
        type: integer
      published:
        type: integer
      host_ip:
        type: string
      protocol:
        type: string
    required:
      - target
  service_ports:
    type: array
    items:
      type: object
      properties:
        target:
          type: integer
        published:
          type: integer
        host_ip:
          type: string
        protocol:
          type: string
      required:
        - target
  service_env:
    type: array
    items:
      type: object
      required: [name, value]
      properties:
        name:
          type: string
        value:
          type: string
  service_volumes:
    type: array
    items:
      type: object
      required: [name, target]
      properties:
        name:
          type: string
        source:
          type: string
        host_path:
          type: string
          pattern: "^/"
        host_path_type:
          type: string
        target:
          type: string
        mode:
          type: string
        driver:
          type: string
        size:
          type: string
  service_networks:
    type: array
    items:
      type: string
  ingress:
    $ref: ingress.schema.yml
  service_unit:
    type: object
    properties:
      description:
        type: string
      after:
        type: array
        items:
          type: string
      service:
        type: object
      install_wanted_by:
        type: array
        items:
          type: string
  service_packages:
    type: array
    items:
      type: string
  service_files:
    type: array
    items:
      type: object
      required: [path, content]
      properties:
        path:
          type: string
        content:
          type: string
        mode:
          type: string
  service_services:
    type: array
    items:
      type: object
      required: [name]
      properties:
        name:
          type: string
        enabled:
          type: boolean
        state:
          type: string
  service_commands:
    type: array
    items:
      type: string
  service_resources:
    type: object
    properties:
      memory_mb:
        type: integer
      cpu_cores:
        type: number
      connections_per_second:
        type: integer
        minimum: 1
  service_namespace:
    type: string
  service_replicas:
    type: integer
  service_storage_gb:
    type: integer
  service_storage_size:
    type: string
  service_gateway:
    type: string
  service_container:
    type: object
    properties:
      vmid:
        type: integer
      hostname:
        type: string
      ostemplate:
        type: string
      disk:
        type: integer
      cores:
        type: integer
      memory:
        type: integer
      swap:
        type: integer
      interface:
        type: string
      bridge:
        type: string
      cidr:
        type: integer
      gateway:
        type: string
      onboot:
        type: string
      unprivileged:
        type: string
      features:
        type: array
        items:
          type: string
  needs_container_runtime:
    type: boolean

  version:
    type: string
  requires:
    type: array
    items:
      anyOf:
        - type: string
        - type: object
          required:
            - name
          properties:
            name:
              type: string
            version:
              type: string
            exports_hash:
              type: string
  exports:
    type: object
    properties:
      env:
        type: array
        items:
          type: object
          required: [name, value]
          properties:
            name:
              type: string
            value:
              type: string
            description:
              type: string
  mounts:
    type: object
    properties:
      persistent_volumes:
        type: array
        items:
          type: object
          required: [name, path]
          properties:
            name:
              type: string
            path:
              type: string
            description:
              type: string
      ephemeral_mounts:
        type: array
        items:
          type: object
          required: [name, path]
          properties:
            name:
              type: string
            path:
              type: string
            apply_to:
              type: array
              items:
                type: string
                enum: [docker, podman, kubernetes, proxmox, baremetal]
            medium:
              type: string
            size:
              type: string
            mode:
              type: string
            read_only:
              type: boolean
    required:
      - persistent_volumes
  health:
    type: object
    required: [cmd]
    properties:
      cmd:
        type: array
      interval:
        type: string
      timeout:
        type: string
      retries:
        type: integer
  secrets:
    type: object
    properties:
      shred_after_apply:
        type: boolean
        default: true
      rotation_timestamp:
        type: string
      env:
        type: array
        items:
          type: object
          required: [name, value]
          properties:
            name:
              type: string
            value:
              type: string
      files:
        type: array
        items:
          type: object
          required: [name, value]
          properties:
            name:
              type: string
            value:
              type: string
            content:
              type: string
            target:
              type: string
            mode:
              type: string
      shred_waiver_reason:
        type: string
        description: >-
          Mandatory justification when secrets.shred_after_apply is overridden to false.
  runtime_templates:
    type: object
  service_security:
    type: object
    properties:
      user:
        type: string
      run_as_user:
        oneOf:
          - type: integer
          - type: string
      run_as_group:
        oneOf:
          - type: integer
          - type: string
      read_only_root_filesystem:
        type: boolean
      capabilities_drop:
        type: array
        items:
          type: string
      no_new_privileges:
        type: boolean
      allow_privilege_escalation:
        type: boolean
      capability_bounding_set:
        type: array
        items:
          type: string
      apparmor_profile:
        type: string
      private_tmp:
        type: boolean
      protect_system:
        type: string
      protect_home:
        oneOf:
          - type: boolean
          - type: string
      system_call_filter:
        oneOf:
          - type: string
          - type: array
            items:
              type: string
  service_restart:
    type: object
    properties:
      restart:
        type: string
      restart_sec:
        type: string
      restart_max_delay_sec:
        type: string
      restart_timeout_sec:
        type: string
      restart_prevent_exit_status:
        oneOf:
          - type: string
          - type: array
            items:
              type: string
      restart_force_exit_status:
        oneOf:
          - type: string
          - type: array
            items:
              type: string
      start_limit_interval_sec:
        type: string
      start_limit_burst:
        type: integer
      start_limit_action:
        type: string
  kubernetes:
    type: object
    properties:
      pvc:
        type: object
        required:
          - name
          - size
        properties:
          name:
            type: string
          size:
            type: string
          storageClassName:
            type: string
allOf:
  - if:
      properties:
        service_container:
          type: object
          properties:
            features:
              type: string
      required:
        - service_container
    then:
      required:
        - needs_container_runtime
      properties:
        needs_container_runtime:
          const: true
  - if:
      properties:
        service_volumes:
          type: array
          contains:
            type: object
            required:
              - host_path
    then:
      properties:
        kubernetes:
          not:
            required:
              - pvc
