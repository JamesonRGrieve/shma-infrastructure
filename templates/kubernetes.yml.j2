#jinja2: lstrip_blocks: True, trim_blocks: True
{% macro render_secret(secret_name, namespace, entries) -%}
{% if entries %}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ secret_name }}
  namespace: {{ namespace }}
type: Opaque
stringData:
{% for key, value in entries.items() %}
  {{ key }}: {{ value | to_json }}
{% endfor %}
{% endif %}
{%- endmacro %}
{% set svc_name = service_name | default(service_id) %}
{% set svc_namespace = service_namespace | default('default') %}
{% set mounts_config = mounts | default({}) %}
{% set ephemeral_mounts = mounts_config.ephemeral_mounts | default([]) %}
{% set default_apply_targets = ['docker', 'podman', 'kubernetes', 'proxmox', 'baremetal'] %}
{% set security = service_security | default({}) %}
{% set default_run_user = security.run_as_user if security.run_as_user is defined else 65532 %}
{% set default_run_group = security.run_as_group if security.run_as_group is defined else default_run_user %}
{% set read_only_root = security.read_only_root_filesystem if security.read_only_root_filesystem is defined else true %}
{% set drop_caps_default = security.capabilities_drop | default(['ALL']) %}
{% if drop_caps_default is string %}{% set drop_caps_default = [drop_caps_default] %}{% endif %}
{% set no_new_privs = security.no_new_privileges if security.no_new_privileges is defined else true %}
{% set allow_priv_escalation = security.allow_privilege_escalation if security.allow_privilege_escalation is defined else (not no_new_privs) %}
{% set ports = service_ports | default([]) %}
{% set container_port = ports[0].target if ports | length > 0 else none %}
{% set service_port_value = ports[0].published if ports | length > 0 and ports[0].published is defined else container_port %}
{% set ingress_raw = ingress | default({}) %}
{% if ingress_raw is mapping %}
  {% set ingress_flag = ingress_raw.get('enabled') %}
  {% set ingress_source_routes = ingress_raw.get('routes', []) %}
{% else %}
  {% set ingress_flag = none %}
  {% set ingress_source_routes = [] %}
{% endif %}
{% set ingress_ns = namespace(items=[]) %}
{% for route in ingress_source_routes if route is mapping %}
  {% set host = route.host if route.host is defined else none %}
  {% set path_prefix = route.path_prefix if route.path_prefix is defined else '/' %}
  {% if host %}
    {% set sanitized_route = route | combine({'path_prefix': path_prefix}) %}
    {% set _ = ingress_ns.items.append(sanitized_route) %}
  {% endif %}
{% endfor %}
{% set ingress_routes = ingress_ns.items %}
{% set ingress_enabled = ((ingress_flag if ingress_flag is not none else (ingress_routes | length > 0)) and container_port is not none) %}
{% set k8s_ephemeral = namespace(items=[]) %}
{% for mount in ephemeral_mounts %}
  {% set apply_targets = mount.apply_to | default(default_apply_targets) %}
  {% if 'kubernetes' in apply_targets %}
    {% set volume_name = mount.name | default('ephemeral-' ~ loop.index) %}
    {% set entry = {
      'volume_name': volume_name,
      'mount_path': mount.path,
      'medium': mount.medium | default('Memory'),
      'size': mount.size if mount.size is defined else None,
      'read_only': mount.read_only if mount.read_only is defined else false
    } %}
    {% if not entry.read_only %}
      {% set _ = k8s_ephemeral.items.append(entry) %}
    {% endif %}
  {% endif %}
{% endfor %}
{% set secret_env = secrets.env if secrets is defined and secrets.env is not none and secrets.env | length > 0 else [] %}
{% set file_secrets = secrets.files if secrets is defined and secrets.files is not none and secrets.files | length > 0 else [] %}
{% set inline_env = service_env | default([]) | list %}
{% set inline_env_ns = namespace(items=inline_env) %}
{% set env_secret_name = svc_name + '-env' %}
{% set file_secret_name = svc_name + '-files' %}
{% set health_cmd = health.cmd | default(['true']) %}
{% set health_interval_seconds = (health.interval | default('10s')) | regex_replace('s$', '') | int %}
{% set health_timeout_seconds = (health.timeout | default('5s')) | regex_replace('s$', '') | int %}
{% set health_retries = health.retries | default(3) %}
{% set replicas = service_replicas | default(1) %}
{% set resources = service_resources | default({'memory_mb': 256, 'cpu_cores': 1}) %}
{% set memory_request = resources.memory_mb | default(256) %}
{% set cpu_cores = resources.cpu_cores | default(1) %}
{% set connections_per_second = resources.connections_per_second if resources.connections_per_second is defined else None %}
{% set volume_config = service_volumes[0] if service_volumes is defined and service_volumes | length > 0 else None %}
{% set use_host_path = volume_config is mapping and volume_config.host_path is defined %}
{% set host_path = volume_config.host_path if use_host_path else None %}
{% set host_path_type = volume_config.host_path_type | default('DirectoryOrCreate') if use_host_path else 'DirectoryOrCreate' %}
{% if service_storage_size is defined %}
{% set storage_size = service_storage_size %}
{% elif volume_config is mapping and volume_config.size is defined %}
{% set storage_size = volume_config.size %}
{% elif service_storage_gb is defined %}
{% set storage_size = service_storage_gb ~ 'Gi' %}
{% else %}
{% set storage_size = '1Gi' %}
{% endif %}
{% set volume_mount_path = volume_config.target if volume_config is mapping and volume_config.target is defined else '/data' %}
{% set env_secret_entries = namespace(items={}) %}
{% for item in secret_env %}
  {% set env_secret_entries.items = env_secret_entries.items | combine({item.name: item.value}) %}
{% endfor %}
{% set file_secret_entries = namespace(items={}) %}
{% for secret in file_secrets %}
  {% set secret_value = secret.value | default(secret.content) | default('', true) %}
  {% set file_secret_entries.items = file_secret_entries.items | combine({secret.name: secret_value}) %}
{% endfor %}
{{ render_secret(env_secret_name, svc_namespace, env_secret_entries.items) }}
{{ render_secret(file_secret_name, svc_namespace, file_secret_entries.items) }}
{%- if not use_host_path -%}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ svc_name }}-data
  namespace: {{ svc_namespace }}
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ storage_size }}
{% endif -%}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ svc_name }}
  namespace: {{ svc_namespace }}
spec:
  replicas: {{ replicas }}
  selector:
    matchLabels:
      app: {{ svc_name }}
  template:
    metadata:
      labels:
        app: {{ svc_name }}
{% if secrets is defined and secrets.rotation_timestamp is defined and secrets.rotation_timestamp is not none %}
      annotations:
        shma.dev/secrets-rotation: "{{ secrets.rotation_timestamp }}"
{% endif %}
    spec:
      securityContext:
        readOnlyRootFilesystem: {{ read_only_root | ternary(true, false) }}
      containers:
        - name: {{ svc_name }}
          image: {{ service_image }}
          securityContext:
            runAsUser: {{ default_run_user | int }}
            runAsGroup: {{ default_run_group | int }}
            runAsNonRoot: true
            readOnlyRootFilesystem: {{ read_only_root | ternary(true, false) }}
            allowPrivilegeEscalation: {{ allow_priv_escalation | ternary(true, false) }}
{% if drop_caps_default %}
            capabilities:
              drop:
{% for cap in drop_caps_default %}
                - {{ cap }}
{% endfor %}
{% endif %}
{% if secrets is defined and secrets.rotation_timestamp is defined and secrets.rotation_timestamp is not none %}
  {% set _ = inline_env_ns.items.append({'name': 'SHMA_SECRETS_ROTATION', 'value': secrets.rotation_timestamp | string}) %}
{% endif %}
{% if connections_per_second is not none %}
  {% set _ = inline_env_ns.items.append({'name': 'CONNECTIONS_PER_SECOND', 'value': connections_per_second | string}) %}
{% endif %}
{% set inline_env = inline_env_ns.items %}
{% set has_secret_env = secret_env | length > 0 %}
{% set has_inline_env = inline_env | length > 0 %}
{% if has_secret_env or has_inline_env %}
          env:
{% if has_secret_env %}
{% for item in secret_env %}
            - name: {{ item.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ env_secret_name }}
                  key: {{ item.name }}
{% endfor %}
{% endif %}
{% if has_inline_env %}
{% for item in inline_env %}
            - name: {{ item.name }}
              value: {{ item.value | to_json }}
{% endfor %}
{% endif %}
{% endif %}
{% if container_port is not none %}
          ports:
            - containerPort: {{ container_port }}
{% endif %}
          volumeMounts:
            - name: data
              mountPath: {{ volume_mount_path }}
{% for mount in k8s_ephemeral.items %}
            - name: {{ mount.volume_name }}
              mountPath: {{ mount.mount_path }}
              readOnly: {{ mount.read_only | ternary(true, false) }}
{% endfor %}
{% if file_secrets %}
{% for secret in file_secrets %}
            - name: secret-files
              mountPath: {{ secret.target | default('/run/secrets/' ~ secret.name) }}
              subPath: {{ secret.name }}
              readOnly: true
{% endfor %}
{% endif %}
          livenessProbe:
            exec:
              command:
{% for arg in health_cmd %}
                - {{ arg }}
{% endfor %}
            initialDelaySeconds: 30
            periodSeconds: {{ health_interval_seconds }}
            timeoutSeconds: {{ health_timeout_seconds }}
            failureThreshold: {{ health_retries }}
          readinessProbe:
            exec:
              command:
{% for arg in health_cmd %}
                - {{ arg }}
{% endfor %}
            initialDelaySeconds: 10
            periodSeconds: {{ health_interval_seconds }}
            timeoutSeconds: {{ health_timeout_seconds }}
            failureThreshold: {{ health_retries }}
            successThreshold: 1
          resources:
            requests:
              memory: {{ memory_request }}Mi
              cpu: {{ (cpu_cores * 1000) | int }}m
            limits:
              memory: {{ memory_request }}Mi
              cpu: {{ (cpu_cores * 1000) | int }}m
      volumes:
        - name: data
{% if use_host_path %}
          hostPath:
            path: {{ host_path }}
            type: {{ host_path_type }}
{% else %}
          persistentVolumeClaim:
            claimName: {{ svc_name }}-data
{% endif %}
{% for mount in k8s_ephemeral.items %}
        - name: {{ mount.volume_name }}
          emptyDir:
            medium: {{ mount.medium | default('Memory') }}
{% if mount.size %}
            sizeLimit: {{ mount.size }}
{% endif %}
{% endfor %}
{% if file_secrets %}
        - name: secret-files
          secret:
            secretName: {{ file_secret_name }}
            items:
{% for secret in file_secrets %}
              - key: {{ secret.name }}
                path: {{ secret.name }}
{% endfor %}
{% endif %}
{% if container_port is not none %}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ svc_name }}
  namespace: {{ svc_namespace }}
spec:
  selector:
    app: {{ svc_name }}
  ports:
    - port: {{ service_port_value }}
      targetPort: {{ container_port }}
  type: ClusterIP
{% if ingress_enabled and ingress_routes %}
{% set tls_map = {} %}
{% for route in ingress_routes %}
  {% set tls = route.tls | default({}) %}
  {% if tls.certificate_secret is defined and tls.certificate_secret %}
    {% set secret_hosts = tls_map.get(tls.certificate_secret, []) + [route.host] %}
    {% set tls_map = tls_map | combine({tls.certificate_secret: secret_hosts | unique}) %}
  {% endif %}
{% endfor %}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ svc_name }}
  namespace: {{ svc_namespace }}
  labels:
    app: {{ svc_name }}
spec:
  rules:
{% for route in ingress_routes %}
    - host: {{ route.host }}
      http:
        paths:
          - path: {{ route.path_prefix }}
            pathType: Prefix
            backend:
              service:
                name: {{ svc_name }}
                port:
                  number: {{ service_port_value }}
{% endfor %}
{% if tls_map %}
  tls:
{% for secret, hosts in tls_map.items() %}
    - secretName: {{ secret }}
      hosts:
{% for host in hosts %}
        - {{ host }}
{% endfor %}
{% endfor %}
{% endif %}
{% endif %}
{% endif %}
{% set network_policy_spec = security.network_policy if security.network_policy is defined and security.network_policy is mapping else {} %}
{% set network_policy_enabled_flag = network_policy_spec.get('enabled') if network_policy_spec else none %}
{% set policy_types_candidate = network_policy_spec.policy_types if network_policy_spec.policy_types is defined and network_policy_spec.policy_types is iterable and network_policy_spec.policy_types is not string else [] %}
{% set policy_types = policy_types_candidate | list if policy_types_candidate else [] %}
{% if not policy_types %}
  {% if container_port is not none %}
    {% set policy_types = ['Ingress', 'Egress'] %}
  {% else %}
    {% set policy_types = ['Egress'] %}
  {% endif %}
{% endif %}
{% set policy_types = policy_types | unique %}
{% set ingress_candidate = network_policy_spec.ingress if network_policy_spec.ingress is defined and network_policy_spec.ingress is iterable and network_policy_spec.ingress is not string else [] %}
{% set egress_candidate = network_policy_spec.egress if network_policy_spec.egress is defined and network_policy_spec.egress is iterable and network_policy_spec.egress is not string else [] %}
{% if 'Ingress' in policy_types %}
  {% set ingress_rules = ingress_candidate | list %}
  {% if not ingress_rules and container_port is not none %}
    {% set default_from = [{'namespaceSelector': {'matchLabels': {'kubernetes.io/metadata.name': svc_namespace}}}] %}
    {% set default_ports = [{'port': service_port_value, 'protocol': 'TCP'}] %}
    {% set ingress_rules = [{'from': default_from, 'ports': default_ports}] %}
  {% endif %}
{% else %}
  {% set ingress_rules = [] %}
{% endif %}
{% if 'Egress' in policy_types %}
  {% set egress_rules = egress_candidate | list %}
  {% if not egress_rules %}
    {% set egress_rules = [{}] %}
  {% endif %}
{% else %}
  {% set egress_rules = [] %}
{% endif %}
{% set network_policy_enabled = (network_policy_enabled_flag if network_policy_enabled_flag is not none else (container_port is not none)) and policy_types %}
{% if network_policy_enabled %}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ svc_name }}
  namespace: {{ svc_namespace }}
spec:
  podSelector:
    matchLabels:
      app: {{ svc_name }}
  policyTypes:
{% for policy_type in policy_types %}
    - {{ policy_type }}
{% endfor %}
{% if ingress_rules %}
  ingress:
{{ ingress_rules | to_nice_yaml(indent=2) | indent(4, True) | regex_replace('(-)\\s+', '\\1 ') }}
{% endif %}
{% if egress_rules %}
  egress:
{{ egress_rules | to_nice_yaml(indent=2) | indent(4, True) | regex_replace('(-)\\s+', '\\1 ') }}
{% endif %}
{% endif %}
