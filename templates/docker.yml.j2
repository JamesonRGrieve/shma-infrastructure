{% set services_list = services | default([{
  'name': service_name | default(service_id),
  'container_name': service_name | default(service_id),
  'image': service_image,
  'env': service_env | default([]),
  'ports': service_ports | default((service_port is defined) | ternary([service_port], [])),
  'volumes': service_volumes | default([]),
  'networks': service_networks | default(['app-network'])
}]) %}
{% set secret_env = secrets.env if secrets is defined and secrets.env is not none and secrets.env | length > 0 else [] %}
{% set file_secrets = secrets.files if secrets is defined and secrets.files is not none and secrets.files | length > 0 else [] %}
{% set env_file_name = (service_name | default(service_id)) + '.env' %}
version: '3.8'

services:
{% for svc in services_list %}
  {{ svc.name }}:
    image: {{ svc.image }}
    container_name: {{ svc.container_name | default(svc.name) }}
    restart: unless-stopped
{% set svc_env_file = svc.env_file | default(env_file_name) %}
{% set svc_secret_env = svc.secret_env | default(secret_env) %}
{% if svc_secret_env %}
    env_file:
      - "./{{ svc_env_file }}"
{% endif %}
{% set inline_env = svc.env | default([]) %}
{% if inline_env %}
    environment:
{% for item in inline_env %}
      {{ item.name }}: {{ item.value }}
{% endfor %}
{% endif %}
{% set volumes = svc.volumes | default([]) %}
{% if volumes %}
    volumes:
{% for vol in volumes %}
      - {% if vol.host_path is defined %}{{ vol.host_path }}{% else %}{{ vol.source | default(vol.name) }}{% endif %}:{{ vol.target }}{% if vol.mode is defined %}:{{ vol.mode }}{% endif %}
{% endfor %}
{% endif %}
{% set ports = svc.ports | default([]) %}
{% if ports %}
    ports:
{% for port in ports %}
      - "{{ port.host_ip | default('') }}{% if port.host_ip is defined and port.host_ip | string | length > 0 %}:{% endif %}{{ port.published | default(port.target) }}:{{ port.target }}{% if port.protocol is defined %}/{{ port.protocol }}{% endif %}"
{% endfor %}
{% endif %}
{% set networks = svc.networks | default(['app-network']) %}
{% if networks %}
    networks:
{% for net in networks %}
      - {{ net }}
{% endfor %}
{% endif %}
{% if health is defined %}
    healthcheck:
      test: {{ health.cmd | default(['true']) | to_json }}
      interval: {{ health.interval | default('10s') }}
      timeout: {{ health.timeout | default('5s') }}
      retries: {{ health.retries | default(3) }}
{% endif %}
{% if file_secrets %}
    secrets:
{% for secret in file_secrets %}
      - source: {{ secret.name }}
        target: {{ secret.target | default(secret.name) }}
        mode: {{ secret.mode | default('0400') }}
{% endfor %}
{% endif %}
{% endfor %}

{% set ns = namespace(volumes=[]) %}
{% for svc in services_list %}
  {% for vol in svc.volumes | default([]) %}
    {% if vol.host_path is not defined %}
      {% set volume_name = vol.source | default(vol.name) %}
      {% set driver = vol.driver | default('local') %}
      {% if ns.volumes | selectattr('name', 'equalto', volume_name) | list | length == 0 %}
        {% set _ = ns.volumes.append({'name': volume_name, 'driver': driver}) %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% if ns.volumes %}
volumes:
{% for volume in ns.volumes %}
  {{ volume.name }}:
    driver: {{ volume.driver }}
{% endfor %}
{% endif %}

{% if file_secrets %}
secrets:
{% for secret in file_secrets %}
  {{ secret.name }}:
    file: "./secrets/{{ secret.name }}"
{% endfor %}
{% endif %}

{% set network_ns = namespace(items=[]) %}
{% for svc in services_list %}
  {% for net in svc.networks | default(['app-network']) %}
    {% if net not in network_ns.items %}
      {% set _ = network_ns.items.append(net) %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% if network_ns.items %}
networks:
{% for net in network_ns.items %}
  {{ net }}:
    driver: bridge
{% endfor %}
{% endif %}
