# Autogenerated by edge_proxy_haproxy role. Do not edit manually.

global
  maxconn 2048

defaults
  mode http
  timeout connect 5s
  timeout client  50s
  timeout server  50s
{% for option in haproxy_default_options %}
  option {{ option }}
{% endfor %}

{% if haproxy_bind_http %}
frontend http_ingress
  bind {{ haproxy_http_bind_address }}
  mode http
{% for backend in edge_ingress_backends | default([]) %}
  acl host_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} hdr(host) -i {{ backend.exports.APP_FQDN }}
{% if backend.path_prefix != '/' %}
  acl path_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} path_beg {{ backend.path_prefix }}
  use_backend {{ backend.service_id }} if host_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} path_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }}
{% else %}
  use_backend {{ backend.service_id }} if host_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }}
{% endif %}
{% endfor %}
{% endif %}

{% if haproxy_bind_https %}
frontend https_ingress
  bind {{ haproxy_https_bind_address }} crt {{ haproxy_https_cert }}
  mode http
{% for backend in edge_ingress_backends | default([]) %}
  acl host_tls_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} hdr(host) -i {{ backend.exports.APP_FQDN }}
{% if backend.path_prefix != '/' %}
  acl path_tls_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} path_beg {{ backend.path_prefix }}
  use_backend {{ backend.service_id }} if host_tls_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }} path_tls_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }}
{% else %}
  use_backend {{ backend.service_id }} if host_tls_{{ backend.service_id | regex_replace('[^A-Za-z0-9_]', '_') }}
{% endif %}
{% endfor %}
{% endif %}

{% for backend in edge_ingress_backends | default([]) %}
backend {{ backend.service_id }}
  mode http
  option httpchk
  http-check send meth GET uri {{ backend.path_prefix if backend.path_prefix != '/' else '/' }}
  server {{ backend.service_id }} {{ backend.exports.APP_BACKEND_IP }}:{{ backend.exports.APP_PORT }} check
{% endfor %}
